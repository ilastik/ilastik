

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ilastik.shell.projectManager &mdash; ilastik 0.6.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.6.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="ilastik 0.6.0 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../../../index.html">ilastik 0.6.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for ilastik.shell.projectManager</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">import</span> <span class="nn">ilastik</span>
<span class="kn">from</span> <span class="nn">ilastik</span> <span class="kn">import</span> <span class="n">isVersionCompatible</span>

<div class="viewcode-block" id="ProjectManager"><a class="viewcode-back" href="../../../projectManager.html#ilastik.shell.projectManager.ProjectManager">[docs]</a><span class="k">class</span> <span class="nc">ProjectManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class manages creating, opening, importing, saving, and closing project files.</span>
<span class="sd">    It instantiates a workflow object and loads its applets with the settings from the </span>
<span class="sd">    project file by using the applets&#39; serializer objects.</span>
<span class="sd">    </span>
<span class="sd">    To open a project file, instantiate a ProjectManager object.</span>
<span class="sd">    To close the project file, delete the ProjectManager object.</span>
<span class="sd">    </span>
<span class="sd">    Once the project manager has been instantiated, clients can access its ``workflow``</span>
<span class="sd">    member for direct access to its applets and their top-level operators.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c">#########################</span>
    <span class="c">## Error types</span>
    <span class="c">#########################    </span>

<div class="viewcode-block" id="ProjectManager.ProjectVersionError"><a class="viewcode-back" href="../../../projectManager.html#ilastik.shell.projectManager.ProjectManager.ProjectVersionError">[docs]</a>    <span class="k">class</span> <span class="nc">ProjectVersionError</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Raised if an attempt is made to open a project file that was generated with an old version of ilastik.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">projectVersion</span><span class="p">,</span> <span class="n">expectedVersion</span><span class="p">):</span>
            <span class="ne">RuntimeError</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;Incompatible project version: {} (Expected: {})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">projectVersion</span><span class="p">,</span> <span class="n">expectedVersion</span><span class="p">)</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">projectVersion</span> <span class="o">=</span> <span class="n">projectVersion</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expectedVersion</span> <span class="o">=</span> <span class="n">expectedVersion</span>
    </div>
<div class="viewcode-block" id="ProjectManager.FileMissingError"><a class="viewcode-back" href="../../../projectManager.html#ilastik.shell.projectManager.ProjectManager.FileMissingError">[docs]</a>    <span class="k">class</span> <span class="nc">FileMissingError</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Raised if an attempt is made to open a project file that can&#39;t be found on disk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="ProjectManager.SaveError"><a class="viewcode-back" href="../../../projectManager.html#ilastik.shell.projectManager.ProjectManager.SaveError">[docs]</a>    <span class="k">class</span> <span class="nc">SaveError</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Raised if saving the project results in an error of some kind.</span>
<span class="sd">        The project file will be in an UNKNOWN and potentially inconsistent state!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="c">#########################</span>
    <span class="c">## Class methods</span>
    <span class="c">#########################    </span>
    </div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ProjectManager.createBlankProjectFile"><a class="viewcode-back" href="../../../projectManager.html#ilastik.shell.projectManager.ProjectManager.createBlankProjectFile">[docs]</a>    <span class="k">def</span> <span class="nf">createBlankProjectFile</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">projectFilePath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class method.</span>
<span class="sd">        Create a new ilp file at the given path and initialize it with a project version.</span>
<span class="sd">        If a file already existed at that location, it will be overwritten with a blank project.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Create the blank project file</span>
        <span class="n">h5File</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">projectFilePath</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">h5File</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s">&quot;ilastikVersion&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ilastik</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">h5File</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ProjectManager.openProjectFile"><a class="viewcode-back" href="../../../projectManager.html#ilastik.shell.projectManager.ProjectManager.openProjectFile">[docs]</a>    <span class="k">def</span> <span class="nf">openProjectFile</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">projectFilePath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class method.</span>
<span class="sd">        Attempt to open the given path to an existing project file.</span>
<span class="sd">        If it doesn&#39;t exist, raise a ``ProjectManager.FileMissingError``.</span>
<span class="sd">        If its version is outdated, raise a ``ProjectManager.ProjectVersionError.``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Opening Project: &quot;</span> <span class="o">+</span> <span class="n">projectFilePath</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">projectFilePath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ProjectManager</span><span class="o">.</span><span class="n">FileMissingError</span><span class="p">()</span>

        <span class="c"># Open the file as an HDF5 file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hdf5File</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">projectFilePath</span><span class="p">)</span>
            <span class="n">readOnly</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="c"># Maybe the project is read-only</span>
            <span class="n">hdf5File</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">projectFilePath</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">readOnly</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="n">projectVersion</span> <span class="o">=</span> <span class="s">&quot;0.5&quot;</span>
        <span class="k">if</span> <span class="s">&quot;ilastikVersion&quot;</span> <span class="ow">in</span> <span class="n">hdf5File</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">projectVersion</span> <span class="o">=</span> <span class="n">hdf5File</span><span class="p">[</span><span class="s">&quot;ilastikVersion&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

        <span class="c"># FIXME: version comparison</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isVersionCompatible</span><span class="p">(</span><span class="n">projectVersion</span><span class="p">):</span>
            <span class="c"># Must use _importProject() for old project files.</span>
            <span class="k">raise</span> <span class="n">ProjectManager</span><span class="o">.</span><span class="n">ProjectVersionError</span><span class="p">(</span><span class="n">projectVersion</span><span class="p">,</span> <span class="n">ilastik</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">(</span><span class="n">hdf5File</span><span class="p">,</span> <span class="n">readOnly</span><span class="p">)</span>

    <span class="c">#########################</span>
    <span class="c">## Public methods</span>
    <span class="c">#########################    </span>
</div>
<div class="viewcode-block" id="ProjectManager.__init__"><a class="viewcode-back" href="../../../projectManager.html#ilastik.shell.projectManager.ProjectManager.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflowClass</span><span class="p">,</span> <span class="n">hdf5File</span><span class="p">,</span> <span class="n">projectFilePath</span><span class="p">,</span> <span class="n">readOnly</span><span class="p">,</span> <span class="n">importFromPath</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">headless</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor.</span>
<span class="sd">        </span>
<span class="sd">        :param workflowClass: A subclass of ilastik.workflow.Workflow (the class, not an instance).</span>
<span class="sd">        :param hdf5File: An already-open h5py.File, usually created via ``ProjectManager.createBlankProjectFile``</span>
<span class="sd">        :param projectFilePath: The path to the file represented in the ``hdf5File`` parameter.</span>
<span class="sd">        :param readOnly: Set to True if the project file should NOT be modified.</span>
<span class="sd">        :param importFromPath: If the project should be overwritten using data imported from a different project, set this parameter to the other project&#39;s filepath.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Instantiate the workflow.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="o">=</span> <span class="n">workflowClass</span><span class="p">(</span><span class="n">headless</span><span class="o">=</span><span class="n">headless</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectFile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectPath</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectIsReadOnly</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">importFromPath</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Normal load        </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loadProject</span><span class="p">(</span><span class="n">hdf5File</span><span class="p">,</span> <span class="n">projectFilePath</span><span class="p">,</span> <span class="n">readOnly</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">readOnly</span><span class="p">,</span> <span class="s">&quot;Can&#39;t import into a read-only file.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_importProject</span><span class="p">(</span><span class="n">importFromPath</span><span class="p">,</span> <span class="n">hdf5File</span><span class="p">,</span> <span class="n">projectFilePath</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Destructor.  Closes the project file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_closeCurrentProject</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span><span class="n">e</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">e</span>


<div class="viewcode-block" id="ProjectManager.getDirtyAppletNames"><a class="viewcode-back" href="../../../projectManager.html#ilastik.shell.projectManager.ProjectManager.getDirtyAppletNames">[docs]</a>    <span class="k">def</span> <span class="nf">getDirtyAppletNames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the serializers for every applet in the workflow.</span>
<span class="sd">        If a serializer declares itself to be dirty (i.e. it is-out-of-sync with the applet&#39;s operator),</span>
<span class="sd">        then the applet&#39;s name is appended to the resulting list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectFile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">dirtyAppletNames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">applet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_applets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">applet</span><span class="o">.</span><span class="n">dataSerializers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">isDirty</span><span class="p">():</span>
                    <span class="n">dirtyAppletNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">applet</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dirtyAppletNames</span>
</div>
<div class="viewcode-block" id="ProjectManager.saveProject"><a class="viewcode-back" href="../../../projectManager.html#ilastik.shell.projectManager.ProjectManager.saveProject">[docs]</a>    <span class="k">def</span> <span class="nf">saveProject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the project file with the state of the current workflow settings.</span>
<span class="sd">        Must not be called if the project file was opened in read-only mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Save Project triggered&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectFile</span> <span class="o">!=</span> <span class="bp">None</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectPath</span> <span class="o">!=</span> <span class="bp">None</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectIsReadOnly</span><span class="p">,</span> <span class="s">&quot;Can&#39;t save a read-only project&quot;</span>

        <span class="c"># Minor GUI nicety: Pre-activate the progress signals for dirty applets so</span>
        <span class="c">#  the progress manager treats these tasks as a group instead of several sequential jobs.</span>
        <span class="k">for</span> <span class="n">aplt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_applets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ser</span> <span class="ow">in</span> <span class="n">aplt</span><span class="o">.</span><span class="n">dataSerializers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ser</span><span class="o">.</span><span class="n">isDirty</span><span class="p">():</span>
                    <span class="n">aplt</span><span class="o">.</span><span class="n">progressSignal</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Applet serializable items are given the whole file (root group) for now</span>
            <span class="k">for</span> <span class="n">aplt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_applets</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">aplt</span><span class="o">.</span><span class="n">dataSerializers</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">item</span><span class="o">.</span><span class="n">base_initialized</span><span class="p">,</span> <span class="s">&quot;AppletSerializer subclasses must call AppletSerializer.__init__ upon construction.&quot;</span>
                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">isDirty</span><span class="p">():</span>
                        <span class="n">item</span><span class="o">.</span><span class="n">serializeToHdf5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentProjectFile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectPath</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Project Save Action failed due to the following exception:&quot;</span><span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">ProjectManager</span><span class="o">.</span><span class="n">SaveError</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c"># Flush any changes we made to disk, but don&#39;t close the file.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectFile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            
            <span class="k">for</span> <span class="n">applet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_applets</span><span class="p">:</span>
                <span class="n">applet</span><span class="o">.</span><span class="n">progressSignal</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProjectManager.saveProjectSnapshot"><a class="viewcode-back" href="../../../projectManager.html#ilastik.shell.projectManager.ProjectManager.saveProjectSnapshot">[docs]</a>    <span class="k">def</span> <span class="nf">saveProjectSnapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshotPath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy the project file as it is, then serialize any dirty state into the copy.</span>
<span class="sd">        Original serializers and project file should not be touched.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">snapshotPath</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">snapshotFile</span><span class="p">:</span>
            <span class="c"># Minor GUI nicety: Pre-activate the progress signals for dirty applets so</span>
            <span class="c">#  the progress manager treats these tasks as a group instead of several sequential jobs.</span>
            <span class="k">for</span> <span class="n">aplt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_applets</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ser</span> <span class="ow">in</span> <span class="n">aplt</span><span class="o">.</span><span class="n">dataSerializers</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ser</span><span class="o">.</span><span class="n">isDirty</span><span class="p">():</span>
                        <span class="n">aplt</span><span class="o">.</span><span class="n">progressSignal</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c"># Start by copying the current project state into the file</span>
            <span class="c"># This should be faster than serializing everything from scratch</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectFile</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">snapshotFile</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentProjectFile</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">key</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c"># Applet serializable items are given the whole file (root group) for now</span>
                <span class="k">for</span> <span class="n">aplt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_applets</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">aplt</span><span class="o">.</span><span class="n">dataSerializers</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">item</span><span class="o">.</span><span class="n">base_initialized</span><span class="p">,</span> <span class="s">&quot;AppletSerializer subclasses must call AppletSerializer.__init__ upon construction.&quot;</span>

                        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">isDirty</span><span class="p">():</span>
                            <span class="c"># Use a COPY of the serializer, so the original serializer doesn&#39;t forget it&#39;s dirty state</span>
                            <span class="n">itemCopy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                            <span class="n">itemCopy</span><span class="o">.</span><span class="n">serializeToHdf5</span><span class="p">(</span><span class="n">snapshotFile</span><span class="p">,</span> <span class="n">snapshotPath</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Project Save Snapshot Action failed due to the following exception:&quot;</span><span class="p">)</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">ProjectManager</span><span class="o">.</span><span class="n">SaveError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c"># Flush any changes we made to disk, but don&#39;t close the file.</span>
                <span class="n">snapshotFile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                
                <span class="k">for</span> <span class="n">applet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_applets</span><span class="p">:</span>
                    <span class="n">applet</span><span class="o">.</span><span class="n">progressSignal</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
                    </div>
<div class="viewcode-block" id="ProjectManager.saveProjectAs"><a class="viewcode-back" href="../../../projectManager.html#ilastik.shell.projectManager.ProjectManager.saveProjectAs">[docs]</a>    <span class="k">def</span> <span class="nf">saveProjectAs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newPath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implement &quot;Save As&quot;</span>
<span class="sd">        Equivalent to the following steps (but done without closing the current project file):</span>

<span class="sd">        1) rename Old.ilp -&gt; New.ilp</span>
<span class="sd">        2) touch Old.ilp</span>
<span class="sd">        3) copycontents New.ilp -&gt; Old.ilp</span>
<span class="sd">        4) Save current applet state to current project (New.ilp)</span>
<span class="sd">        </span>
<span class="sd">        Postconditions: - Original project state is saved to a new file with the original name.</span>
<span class="sd">                        - Current project file is still open, but has a new name.</span>
<span class="sd">                        - Current project file has been saved (it is in sync with the applet states)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># If our project is read-only, we can&#39;t be efficient.</span>
        <span class="c"># We have to take a snapshot, then close our current project and open the snapshot</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectIsReadOnly</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_takeSnapshotAndLoadIt</span><span class="p">(</span><span class="n">newPath</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">oldPath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectPath</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span> <span class="n">oldPath</span><span class="p">,</span> <span class="n">newPath</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Could not rename your project file to:</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="n">newPath</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39;One common cause for this is that the new location is on a different disk.</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39;Please try &quot;Take Snapshot&quot; instead.&#39;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s">&#39;(Error was: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;)&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ProjectManager</span><span class="o">.</span><span class="n">SaveError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c"># The file has been renamed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectPath</span> <span class="o">=</span> <span class="n">newPath</span>

        <span class="c"># Copy the contents of the current project file to a newly-created file (with the old name)        </span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">oldPath</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">oldFile</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectFile</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">oldFile</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentProjectFile</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">key</span><span class="p">)</span>

        <span class="c"># Save the current project state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveProject</span><span class="p">()</span>
        
    <span class="c">#########################</span>
    <span class="c">## Private methods</span>
    <span class="c">#########################    </span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_applets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">applets</span>

    <span class="k">def</span> <span class="nf">_loadProject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdf5File</span><span class="p">,</span> <span class="n">projectFilePath</span><span class="p">,</span> <span class="n">readOnly</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the data from the given hdf5File (which should already be open).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectFile</span> <span class="ow">is</span> <span class="bp">None</span>

        <span class="c"># Minor GUI nicety: Pre-activate the progress signals for all applets so</span>
        <span class="c">#  the progress manager treats these tasks as a group instead of several sequential jobs.</span>
        <span class="k">for</span> <span class="n">aplt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_applets</span><span class="p">:</span>
            <span class="n">aplt</span><span class="o">.</span><span class="n">progressSignal</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># Save this as the current project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectFile</span> <span class="o">=</span> <span class="n">hdf5File</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectPath</span> <span class="o">=</span> <span class="n">projectFilePath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectIsReadOnly</span> <span class="o">=</span> <span class="n">readOnly</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Applet serializable items are given the whole file (root group)</span>
            <span class="k">for</span> <span class="n">aplt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_applets</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">aplt</span><span class="o">.</span><span class="n">dataSerializers</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">item</span><span class="o">.</span><span class="n">base_initialized</span><span class="p">,</span> <span class="s">&quot;AppletSerializer subclasses must call AppletSerializer.__init__ upon construction.&quot;</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">deserializeFromHdf5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentProjectFile</span><span class="p">,</span> <span class="n">projectFilePath</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Project could not be loaded due to the following exception:&quot;</span><span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Aborting Project Open Action&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_closeCurrentProject</span><span class="p">()</span>

            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">aplt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_applets</span><span class="p">:</span>
                <span class="n">aplt</span><span class="o">.</span><span class="n">progressSignal</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_takeSnapshotAndLoadIt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newPath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is effectively a &quot;save as&quot;, but is slower because the operators are totally re-loaded.</span>
<span class="sd">        All caches, etc. will be lost.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveProjectSnapshot</span><span class="p">(</span> <span class="n">newPath</span> <span class="p">)</span>
        <span class="n">hdf5File</span><span class="p">,</span> <span class="n">readOnly</span> <span class="o">=</span> <span class="n">ProjectManager</span><span class="o">.</span><span class="n">openProjectFile</span><span class="p">(</span> <span class="n">newPath</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadProject</span><span class="p">(</span><span class="n">hdf5File</span><span class="p">,</span> <span class="n">newPath</span><span class="p">,</span> <span class="n">readOnly</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_importProject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">importedFilePath</span><span class="p">,</span> <span class="n">newProjectFile</span><span class="p">,</span> <span class="n">newProjectFilePath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the data from a project and save it to a different project file.</span>
<span class="sd">        </span>
<span class="sd">        importedFilePath - The path to a (not open) .ilp file to import data from</span>
<span class="sd">        newProjectFile - An hdf5 handle to a new .ilp to load data into (must be open already)</span>
<span class="sd">        newProjectFilePath - The path to the new .ilp we&#39;re loading.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">importedFilePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">importedFilePath</span><span class="p">)</span>
        
        <span class="c"># Open and load the original project file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">importedFile</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">importedFilePath</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Error opening file: &quot;</span> <span class="o">+</span> <span class="n">importedFilePath</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="c"># Load the imported project into the workflow state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadProject</span><span class="p">(</span><span class="n">importedFile</span><span class="p">,</span> <span class="n">importedFilePath</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        
        <span class="c"># Export the current workflow state to the new file.</span>
        <span class="c"># (Somewhat hacky: We temporarily swap the new file object as our current one during the save.)</span>
        <span class="n">origProjectFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectFile</span> <span class="o">=</span> <span class="n">newProjectFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectPath</span> <span class="o">=</span> <span class="n">newProjectFilePath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectIsReadOnly</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveProject</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectFile</span> <span class="o">=</span> <span class="n">origProjectFile</span>

        <span class="c"># Close the original project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_closeCurrentProject</span><span class="p">()</span>

        <span class="c"># Discard the old workflow and make a new one</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">__class__</span><span class="p">()</span>

        <span class="c"># Load the new file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadProject</span><span class="p">(</span><span class="n">newProjectFile</span><span class="p">,</span> <span class="n">newProjectFilePath</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_closeCurrentProject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">cleanUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workflow</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectFile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectFile</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectPath</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentProjectIsReadOnly</span> <span class="o">=</span> <span class="bp">False</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../../../index.html">ilastik 0.6.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Christoph Straehle, Bernhard X. Kausler, Thorben Kröger, Ullrich Köthe , Fred A. Hamprecht, Anna Kreshuk, Luca Fiaschi, Stuart Berg.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>